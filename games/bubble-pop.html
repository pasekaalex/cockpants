<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bubble Buddy Bubble Pop | $COCKPANTS Games ü´ß</title>
  <meta name="description" content="Pop bubbles with Bubble Buddy! Match colors and clear the board!">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../leaderboard.js"></script>
  <script src="../sounds.js"></script>
  <style>
    @font-face {
      font-family: 'Krabby Patty';
      src: url('../Krabby Patty.ttf') format('truetype');
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
    
    body {
      font-family: 'Krabby Patty', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      overflow: hidden;
      position: relative;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 30%, rgba(255,255,255,0.15) 0%, transparent 40%),
                  radial-gradient(circle at 80% 70%, rgba(255,255,255,0.1) 0%, transparent 40%);
      pointer-events: none;
      z-index: 0;
    }
    
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      padding: 12px 24px;
      font-family: 'Krabby Patty', Arial, sans-serif;
      font-size: 18px;
      cursor: pointer;
      border-radius: 15px;
      text-decoration: none;
      z-index: 1000;
    }
    
    .leaderboard-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 165, 0, 0.9));
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: #000;
      padding: 12px 24px;
      font-family: 'Krabby Patty', Arial, sans-serif;
      font-size: 18px;
      cursor: pointer;
      border-radius: 15px;
      z-index: 1000;
      font-weight: bold;
    }
    
    .game-container {
      position: relative;
      z-index: 1;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 30px;
      padding: 25px;
    }
    
    .ui-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      padding: 15px 25px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 20px;
    }
    
    .ui-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      min-width: 120px;
    }
    
    .ui-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      text-transform: uppercase;
    }
    
    .ui-value {
      font-size: 28px;
      font-weight: bold;
      color: #FFD700;
    }
    
    #gameCanvas {
      display: block;
      background: linear-gradient(180deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      cursor: crosshair;
    }
    
    .shooter-container {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      height: 90px;
    }
    
    .shooter {
      width: 70px;
      height: 70px;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.9), rgba(76, 175, 80, 0.8));
      border: 3px solid rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
    }
    
    .menu-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .menu-screen.hidden {
      display: none !important;
    }
    
    .menu-title {
      font-size: 72px;
      color: #FFD700;
      margin-bottom: 20px;
      text-align: center;
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .menu-icon {
      font-size: 140px;
      margin-bottom: 30px;
    }
    
    .menu-btn {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      padding: 18px 45px;
      font-family: 'Krabby Patty', Arial, sans-serif;
      font-size: 24px;
      cursor: pointer;
      border-radius: 20px;
      margin: 12px;
    }
    
    .menu-btn:hover {
      transform: scale(1.05);
      background: rgba(255, 255, 255, 0.3);
    }
    
    .game-over-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255, 68, 68, 0.95), rgba(200, 0, 0, 0.95));
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .game-over-screen.show {
      display: flex;
    }
    
    .game-over-title {
      font-size: 64px;
      color: #fff;
      margin-bottom: 20px;
    }
    
    .final-score {
      font-size: 42px;
      color: #FFD700;
      margin-bottom: 30px;
    }
    
    .character-image {
      position: fixed;
      z-index: 500;
      pointer-events: none;
      opacity: 0;
      max-width: 140px;
      transition: opacity 0.5s;
      filter: drop-shadow(0 5px 15px rgba(0,0,0,0.4));
    }
    
    .character-image.center {
      right: 20px;
      bottom: 20px;
      animation: bubbleBuddyFloat 4s ease-in-out infinite;
    }
    
    @keyframes bubbleBuddyFloat {
      0%, 100% { transform: translateY(0) rotate(-2deg); }
      50% { transform: translateY(-15px) rotate(2deg); }
    }
    
    /* Menu images with swaying animation */
    .menu-images {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .menu-image {
      max-width: 150px;
      height: auto;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    
    .menu-image.sway-left {
      animation: swayLeft 3s ease-in-out infinite;
    }
    
    .menu-image.sway-right {
      animation: swayRight 3s ease-in-out infinite;
    }
    
    .menu-image.sway-center {
      animation: swayCenter 2.5s ease-in-out infinite;
    }
    
    @keyframes swayLeft {
      0%, 100% { transform: rotate(-3deg) translateY(0); }
      50% { transform: rotate(3deg) translateY(-10px); }
    }
    
    @keyframes swayRight {
      0%, 100% { transform: rotate(3deg) translateY(0); }
      50% { transform: rotate(-3deg) translateY(-10px); }
    }
    
    @keyframes swayCenter {
      0%, 100% { transform: scale(1) translateY(0); }
      50% { transform: scale(1.05) translateY(-8px); }
    }
    
    @media (max-width: 768px) {
      .game-container { padding: 12px; width: 98vw; }
      #gameCanvas { width: 100%; height: auto; }
      .menu-title { font-size: 42px; }
      .menu-icon { font-size: 100px; }
      .menu-btn { font-size: 18px; padding: 15px 30px; }
      .ui-value { font-size: 20px; }
      .character-image { max-width: 80px; right: 10px; bottom: 10px; }
      .menu-images { gap: 15px; }
      .menu-image { max-width: 100px; }
    }
  </style>
</head>
<body>
  <a href="../index.html" class="back-btn">‚¨ÖÔ∏è MENU</a>
  <button class="leaderboard-btn" onclick="openLeaderboard()">üèÜ LEADERBOARD</button>
  
  <div class="menu-screen" id="menuScreen">
    <div class="menu-icon">ü´ß</div>
    <h1 class="menu-title">BUBBLE BUDDY<br>BUBBLE POP</h1>
    <div class="menu-images">
      <img src="https://i.imgur.com/PA0NHpg.png" alt="SpongeBob & Bubble Buddy" class="menu-image sway-left" />
      <img src="https://i.imgur.com/U4fJepp.png" alt="Bubble Buddy drinking soda" class="menu-image sway-center" />
      <img src="https://i.imgur.com/znHCHsf.png" alt="Squidward & Bubble Buddy" class="menu-image sway-right" />
    </div>
    <button class="menu-btn" id="startBtn">üéÆ START GAME</button>
    <div style="color: #fff; text-align: center; margin-top: 20px; max-width: 500px; padding: 0 20px;">
      <p style="font-size: 18px; margin-bottom: 10px;">üéØ Match 3+ bubbles of the same color!</p>
      <p style="font-size: 14px; color: rgba(255,255,255,0.8);">Click or tap to aim and shoot.</p>
    </div>
  </div>
  
  <div class="game-over-screen" id="gameOverScreen">
    <div class="game-over-title">GAME OVER</div>
    <div class="final-score" id="finalScore">Score: 0</div>
    <button class="menu-btn" id="restartBtn">üîÑ PLAY AGAIN</button>
    <button class="menu-btn" id="leaderboardBtn">üèÜ LEADERBOARD</button>
  </div>
  
  <!-- Bubble Buddy drinking soda - shown during gameplay -->
  <img src="https://i.imgur.com/U4fJepp.png" alt="Bubble Buddy" class="character-image center" id="gameCharacter" />
  
  <div class="game-container">
    <div class="ui-bar">
      <div class="ui-item">
        <div class="ui-label">SCORE</div>
        <div class="ui-value" id="scoreDisplay">0</div>
      </div>
      <div class="ui-item">
        <div class="ui-label">LEVEL</div>
        <div class="ui-value" id="levelDisplay">1</div>
      </div>
      <div class="ui-item">
        <div class="ui-label">BUBBLES</div>
        <div class="ui-value" id="bubblesDisplay">0</div>
      </div>
    </div>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div class="shooter-container">
      <div class="shooter">ü´ß</div>
    </div>
  </div>

  <script>
    // GAME VARIABLES
    var canvas, ctx;
    var score = 0;
    var level = 1;
    var bubbles = [];
    var shotBubble = null;
    var nextBubble = null;
    var isShooting = false;
    var gameOver = false;
    var gameRunning = false;
    var mouseX = 400;
    var mouseY = 300;
    var SHOOTER_X = 400;
    var SHOOTER_Y = 550;
    
    var BUBBLE_RADIUS = 20;
    var BUBBLE_SPACING = 42;
    var ROWS = 8;
    var COLS = 15;
    var SHOT_SPEED = 12;
    
    // More distinct, vibrant colors
    var COLORS = [
      {main: '#FF0000', light: '#FF6666'},  // Bright Red
      {main: '#00CC00', light: '#66FF66'},  // Bright Green
      {main: '#0066FF', light: '#66AAFF'},  // Bright Blue
      {main: '#FFCC00', light: '#FFEE66'},  // Bright Yellow
      {main: '#FF00FF', light: '#FF88FF'},  // Magenta/Pink
      {main: '#FF6600', light: '#FFAA66'}   // Orange
    ];
    
    // INITIALIZATION
    function init() {
      canvas = document.getElementById('gameCanvas');
      if (!canvas) {
        console.error('Canvas not found!');
        return;
      }
      ctx = canvas.getContext('2d');
      
      // Set canvas size
      if (window.innerWidth < 768) {
        canvas.width = Math.min(700, window.innerWidth - 40);
        canvas.height = 500;
        BUBBLE_RADIUS = 16;
        BUBBLE_SPACING = 34;
        COLS = 12;
        ROWS = 7;
      }
      
      SHOOTER_X = canvas.width / 2;
      SHOOTER_Y = canvas.height - 50;
      
      // Event listeners
      document.getElementById('startBtn').addEventListener('click', startGame);
      document.getElementById('restartBtn').addEventListener('click', restartGame);
      document.getElementById('leaderboardBtn').addEventListener('click', openLeaderboard);
      
      canvas.addEventListener('click', handleCanvasClick);
      canvas.addEventListener('mousemove', handleMouseMove);
      canvas.addEventListener('touchstart', handleTouch, {passive: false});
      canvas.addEventListener('touchmove', handleTouchMove, {passive: false});
      canvas.addEventListener('touchend', handleTouchEnd, {passive: false});
      
      console.log('Game initialized!');
    }
    
    function startGame() {
      console.log('Starting game...');
      document.getElementById('menuScreen').classList.add('hidden');
      
      // Show Bubble Buddy during gameplay
      var gameChar = document.getElementById('gameCharacter');
      if (gameChar) {
        gameChar.style.opacity = '0.7';
      }
      
      // Reset game state
      score = 0;
      level = 1;
      bubbles = [];
      shotBubble = null;
      isShooting = false;
      gameOver = false;
      gameRunning = true;
      
      createBubbleGrid();
      nextBubble = createBubble(SHOOTER_X, SHOOTER_Y);
      updateUI();
      
      requestAnimationFrame(gameLoop);
    }
    
    function restartGame() {
      document.getElementById('gameOverScreen').classList.remove('show');
      document.getElementById('menuScreen').classList.remove('hidden');
      
      // Hide Bubble Buddy
      var gameChar = document.getElementById('gameCharacter');
      if (gameChar) {
        gameChar.style.opacity = '0';
      }
      
      gameRunning = false;
    }
    
    function openLeaderboard() {
      if (typeof showLeaderboardModal === 'function') {
        showLeaderboardModal('bubble-pop', 'Bubble Buddy Bubble Pop', score);
      }
    }
    
    function createBubbleGrid() {
      bubbles = [];
      for (var row = 0; row < ROWS; row++) {
        for (var col = 0; col < COLS; col++) {
          var x = col * BUBBLE_SPACING + (row % 2 === 1 ? BUBBLE_SPACING / 2 : 0) + BUBBLE_RADIUS + 30;
          var y = row * BUBBLE_SPACING + 40;
          
          if (x + BUBBLE_RADIUS < canvas.width - 20 && Math.random() > 0.25) {
            var colorIdx = Math.floor(Math.random() * COLORS.length);
            bubbles.push({
              x: x,
              y: y,
              color: COLORS[colorIdx],
              row: row,
              col: col,
              radius: BUBBLE_RADIUS
            });
          }
        }
      }
    }
    
    function createBubble(x, y) {
      var colorIdx = Math.floor(Math.random() * COLORS.length);
      return {
        x: x,
        y: y,
        color: COLORS[colorIdx],
        radius: BUBBLE_RADIUS,
        vx: 0,
        vy: 0
      };
    }
    
    function handleCanvasClick(e) {
      if (gameOver || isShooting || !nextBubble) return;
      
      var rect = canvas.getBoundingClientRect();
      var clickX = (e.clientX - rect.left) * (canvas.width / rect.width);
      var clickY = (e.clientY - rect.top) * (canvas.height / rect.height);
      
      shoot(clickX, clickY);
    }
    
    function handleMouseMove(e) {
      if (gameOver || isShooting) return;
      var rect = canvas.getBoundingClientRect();
      mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
      mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);
    }
    
    function handleTouch(e) {
      e.preventDefault();
      var rect = canvas.getBoundingClientRect();
      var touch = e.touches[0];
      mouseX = (touch.clientX - rect.left) * (canvas.width / rect.width);
      mouseY = (touch.clientY - rect.top) * (canvas.height / rect.height);
    }
    
    function handleTouchMove(e) {
      e.preventDefault();
      handleTouch(e);
    }
    
    function handleTouchEnd(e) {
      e.preventDefault();
      if (gameOver || isShooting || !nextBubble) return;
      shoot(mouseX, mouseY);
    }
    
    function shoot(targetX, targetY) {
      if (targetY >= SHOOTER_Y - 20) return; // Don't shoot downward
      
      isShooting = true;
      shotBubble = {
        x: SHOOTER_X,
        y: SHOOTER_Y,
        color: nextBubble.color,
        radius: BUBBLE_RADIUS,
        vx: 0,
        vy: 0
      };
      
      var dx = targetX - SHOOTER_X;
      var dy = targetY - SHOOTER_Y;
      var dist = Math.sqrt(dx * dx + dy * dy);
      
      shotBubble.vx = (dx / dist) * SHOT_SPEED;
      shotBubble.vy = (dy / dist) * SHOT_SPEED;
      
      nextBubble = createBubble(SHOOTER_X, SHOOTER_Y);
      
      // Play sound
      if (typeof soundManager !== 'undefined' && soundManager.play) {
        soundManager.play('cash');
      }
    }
    
    function updateShotBubble() {
      if (!shotBubble) return;
      
      shotBubble.x += shotBubble.vx;
      shotBubble.y += shotBubble.vy;
      
      // Wall bounce
      if (shotBubble.x - BUBBLE_RADIUS <= 0 || shotBubble.x + BUBBLE_RADIUS >= canvas.width) {
        shotBubble.vx *= -1;
        shotBubble.x = Math.max(BUBBLE_RADIUS, Math.min(canvas.width - BUBBLE_RADIUS, shotBubble.x));
      }
      
      // Ceiling hit
      if (shotBubble.y - BUBBLE_RADIUS <= 0) {
        attachBubble();
        return;
      }
      
      // Check collision with other bubbles
      for (var i = 0; i < bubbles.length; i++) {
        var b = bubbles[i];
        var dx = shotBubble.x - b.x;
        var dy = shotBubble.y - b.y;
        var dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist < BUBBLE_RADIUS * 2) {
          attachBubble();
          return;
        }
      }
    }
    
    function attachBubble() {
      if (!shotBubble) return;
      
      // Snap to grid
      var row = Math.round((shotBubble.y - 40) / BUBBLE_SPACING);
      var col = Math.round((shotBubble.x - BUBBLE_RADIUS - 30 - (row % 2 === 1 ? BUBBLE_SPACING / 2 : 0)) / BUBBLE_SPACING);
      
      row = Math.max(0, row);
      col = Math.max(0, Math.min(COLS - 1, col));
      
      var x = col * BUBBLE_SPACING + (row % 2 === 1 ? BUBBLE_SPACING / 2 : 0) + BUBBLE_RADIUS + 30;
      var y = row * BUBBLE_SPACING + 40;
      
      bubbles.push({
        x: x,
        y: y,
        color: shotBubble.color,
        row: row,
        col: col,
        radius: BUBBLE_RADIUS
      });
      
      shotBubble = null;
      isShooting = false;
      
      checkMatches();
      checkFloating();
      checkWinLose();
      updateUI();
    }
    
    function checkMatches() {
      var lastBubble = bubbles[bubbles.length - 1];
      if (!lastBubble) return;
      
      var matched = [];
      var visited = [];
      
      function findMatches(bubble) {
        if (visited.indexOf(bubble) !== -1) return;
        visited.push(bubble);
        matched.push(bubble);
        
        for (var i = 0; i < bubbles.length; i++) {
          var b = bubbles[i];
          if (visited.indexOf(b) !== -1) continue;
          if (b.color.main !== bubble.color.main) continue;
          
          var dx = b.x - bubble.x;
          var dy = b.y - bubble.y;
          var dist = Math.sqrt(dx * dx + dy * dy);
          
          if (dist < BUBBLE_SPACING + 5) {
            findMatches(b);
          }
        }
      }
      
      findMatches(lastBubble);
      
      if (matched.length >= 3) {
        for (var i = 0; i < matched.length; i++) {
          var idx = bubbles.indexOf(matched[i]);
          if (idx !== -1) {
            bubbles.splice(idx, 1);
          }
        }
        score += matched.length * 10 * level;
        
        if (typeof soundManager !== 'undefined' && soundManager.play) {
          soundManager.play('money');
        }
      }
    }
    
    function checkFloating() {
      var connected = [];
      
      // Find all bubbles connected to top
      function markConnected(bubble) {
        if (connected.indexOf(bubble) !== -1) return;
        connected.push(bubble);
        
        for (var i = 0; i < bubbles.length; i++) {
          var b = bubbles[i];
          if (connected.indexOf(b) !== -1) continue;
          
          var dx = b.x - bubble.x;
          var dy = b.y - bubble.y;
          var dist = Math.sqrt(dx * dx + dy * dy);
          
          if (dist < BUBBLE_SPACING + 5) {
            markConnected(b);
          }
        }
      }
      
      // Start from top row
      for (var i = 0; i < bubbles.length; i++) {
        if (bubbles[i].row === 0) {
          markConnected(bubbles[i]);
        }
      }
      
      // Remove floating bubbles
      var floating = [];
      for (var i = bubbles.length - 1; i >= 0; i--) {
        if (connected.indexOf(bubbles[i]) === -1) {
          floating.push(bubbles[i]);
          bubbles.splice(i, 1);
        }
      }
      
      if (floating.length > 0) {
        score += floating.length * 20 * level;
      }
    }
    
    function checkWinLose() {
      if (bubbles.length === 0) {
        level++;
        createBubbleGrid();
        score += 1000 * level;
        if (typeof soundManager !== 'undefined' && soundManager.play) {
          soundManager.play('ohyeah');
        }
        return;
      }
      
      // Check if bubbles reached bottom
      for (var i = 0; i < bubbles.length; i++) {
        if (bubbles[i].y > canvas.height - 150) {
          endGame();
          return;
        }
      }
    }
    
    function endGame() {
      gameOver = true;
      gameRunning = false;
      document.getElementById('finalScore').textContent = 'Score: ' + score.toLocaleString();
      document.getElementById('gameOverScreen').classList.add('show');
      
      if (typeof soundManager !== 'undefined' && soundManager.play) {
        soundManager.play('scream');
      }
      
      setTimeout(function() {
        if (typeof showLeaderboardModal === 'function') {
          showLeaderboardModal('bubble-pop', 'Bubble Buddy Bubble Pop', score);
        }
      }, 1000);
    }
    
    function updateUI() {
      document.getElementById('scoreDisplay').textContent = score.toLocaleString();
      document.getElementById('levelDisplay').textContent = level;
      document.getElementById('bubblesDisplay').textContent = bubbles.length;
    }
    
    function drawBubble(x, y, color, radius) {
      // Outer glow
      ctx.beginPath();
      ctx.arc(x, y, radius + 3, 0, Math.PI * 2);
      ctx.fillStyle = color.main + '44'; // Semi-transparent glow
      ctx.fill();
      
      // Shadow
      ctx.beginPath();
      ctx.arc(x + 2, y + 3, radius, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(0,0,0,0.25)';
      ctx.fill();
      
      // Main bubble with gradient
      var gradient = ctx.createRadialGradient(x - radius * 0.3, y - radius * 0.3, 0, x, y, radius);
      gradient.addColorStop(0, color.light);
      gradient.addColorStop(0.7, color.main);
      gradient.addColorStop(1, color.main);
      
      ctx.beginPath();
      ctx.arc(x, y, radius, 0, Math.PI * 2);
      ctx.fillStyle = gradient;
      ctx.fill();
      
      // Border for definition
      ctx.strokeStyle = 'rgba(255,255,255,0.4)';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // Main highlight
      ctx.beginPath();
      ctx.arc(x - radius * 0.3, y - radius * 0.35, radius * 0.35, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255,255,255,0.6)';
      ctx.fill();
      
      // Small secondary highlight
      ctx.beginPath();
      ctx.arc(x + radius * 0.2, y + radius * 0.2, radius * 0.15, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255,255,255,0.3)';
      ctx.fill();
    }
    
    function render() {
      // Clear
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw grid bubbles
      for (var i = 0; i < bubbles.length; i++) {
        var b = bubbles[i];
        drawBubble(b.x, b.y, b.color, b.radius);
      }
      
      // Draw shot bubble
      if (shotBubble) {
        drawBubble(shotBubble.x, shotBubble.y, shotBubble.color, shotBubble.radius);
      }
      
      // Draw next bubble preview
      if (nextBubble && !isShooting) {
        ctx.globalAlpha = 0.7;
        drawBubble(SHOOTER_X, SHOOTER_Y - 40, nextBubble.color, nextBubble.radius);
        ctx.globalAlpha = 1;
        
        // Draw aim line
        if (mouseY < SHOOTER_Y - 20) {
          ctx.strokeStyle = 'rgba(255, 215, 0, 0.5)';
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 5]);
          ctx.beginPath();
          ctx.moveTo(SHOOTER_X, SHOOTER_Y);
          ctx.lineTo(mouseX, mouseY);
          ctx.stroke();
          ctx.setLineDash([]);
        }
      }
    }
    
    function gameLoop() {
      if (!gameRunning) return;
      
      if (!gameOver) {
        updateShotBubble();
        render();
      }
      
      requestAnimationFrame(gameLoop);
    }
    
    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    
    // Global functions for onclick handlers
    window.startGame = startGame;
    window.restartGame = restartGame;
    window.openLeaderboard = openLeaderboard;
  </script>
</body>
</html>
